CKAN: The Open Source Data Portal Software
==========================================

.. image:: https://img.shields.io/badge/license-AGPL-blue.svg?style=flat
    :target: https://opensource.org/licenses/AGPL-3.0
    :alt: License

.. image:: https://img.shields.io/badge/docs-latest-brightgreen.svg?style=flat
    :target: http://docs.ckan.org
    :alt: Documentation
.. image:: https://img.shields.io/badge/support-StackOverflow-yellowgreen.svg?style=flat
    :target: https://stackoverflow.com/questions/tagged/ckan
    :alt: Support on StackOverflow

.. image:: https://circleci.com/gh/ckan/ckan.svg?style=shield
    :target: https://circleci.com/gh/ckan/ckan
    :alt: Build Status

.. image:: https://coveralls.io/repos/github/ckan/ckan/badge.svg?branch=master
    :target: https://coveralls.io/github/ckan/ckan?branch=master
    :alt: Coverage Status

.. image:: https://badges.gitter.im/gitterHQ/gitter.svg
    :target: https://gitter.im/ckan/chat
    :alt: Chat on Gitter

**CKAN is the worldâ€™s leading open-source data portal platform**.
CKAN makes it easy to publish, share and work with data. It's a data management
system that provides a powerful platform for cataloging, storing and accessing
datasets with a rich front-end, full API (for both data and catalog), visualization
tools and more. Read more at `ckan.org <http://ckan.org/>`_.

Additions
------------

In this CKAN setup, `oauth2 authentication <https://github.com/conwetlab/ckanext-oauth2>`_ 
is added as well as the `rule <https://github.com/vwt-digital/ckan/tree/develop/ckanext/ckanext-viewerpermissions>`_ 
that only authenticated users can see certain datasets.

Local Installation
------------

To run this CKAN setup locally, use the 
`CKAN installation instructions for Docker 
compose <https://docs.ckan.org/en/2.8/maintaining/installing/install-from-docker-compose.html>`_
in the folder `contrib/docker <https://github.com/vwt-digital/ckan/tree/develop/contrib/docker>`_ if you want to run it 
with a local database. Or in the folder `contrib/docker-GCP <https://github.com/vwt-digital/ckan/tree/develop/contrib/docker>`_ 
if you want to run it with a `Google Cloud Platform (GCP) <https://cloud.google.com>`_ database.

Furthermore make sure that the 'port' variable in 
`deployment.ini_tmpl <https://github.com/vwt-digital/ckan/blob/develop/ckan/config/deployment.ini_tmpl>`_ is set to the right 
port (probably 5000).

If you want to run CKAN with GCP settings, set the 'GCP' variable in the 
`Dockerfile <https://github.com/vwt-digital/ckan/blob/develop/Dockerfile>`_ to 'yes'.

Google Cloud Platform Installation
------------

To run this CKAN setup on `Google Cloud Platform (GCP) <https://cloud.google.com>`_ build the container image via the 
`Dockerfile <https://github.com/vwt-digital/ckan/blob/develop/Dockerfile>`_ and push it to GCP.
For more information see 
`Build Using Dockerfile <https://cloud.google.com/cloud-build/docs/quickstart-build#build_using_dockerfile>`_.

Environment Variables
------------

The following environment variables need to be set. See the github of 
`ckanext-oauth2 <https://github.com/conwetlab/ckanext-oauth2/wiki/Activating-and-Installing>`_ for more information.

**Note:** the .env files are made by copying the .env.template files and renaming them to .env.

**Locally:** in the .env file in contrib/docker:
::
        CKAN_SOLR_PASSWORD
        SOLR_PORT
        CKAN_SOLR_URL
        CKAN_OAUTH2_AUTHORIZATION_ENDPOINT
        CKAN_OAUTH2_TOKEN_ENDPOINT
        CKAN_OAUTH2_CLIENT_ID
        CKAN_OAUTH2_CLIENT_SECRET
        CKAN_OAUTH2_SCOPE
        CKAN_OAUTH2_PROFILE_API_URL
        CKAN_OAUTH2_PROFILE_API_USER_FIELD
        CKAN_OAUTH2_PROFILE_API_MAIL_FIELD
        OAUTHLIB_INSECURE_TRANSPORT
        OAUTHLIB_RELAX_TOKEN_SCOPE
        CKAN_PRIVATE_ORGS

**Note:** When using GCP, make sure that CKAN_SOLR_PASSWORD is the same as the file set_users.json in contrib/docker-GCP/solr. 
set_users.json can be generated by calling contrib/docker-GCP/solr/solr_set_user.py.

Where CKAN_PRIVATE_ORGS are the organisations in CKAN that have datasets that should only be visible to authenticated users.
::
        CKAN_PRIVATE_ORGS=organisation1,organisation2,etcetera

**Note:** Organisations are being segregated by a comma (',').

**GCP:** Only the following two values do not have to be added, unless running locally:
::
        SOLR_PORT
        CKAN_SOLR_URL

The rest of the values that have to be added to the .env file above have to be added as environment
variables to the Docker image. With addition:
::
        CKAN_SQLALCHEMY_URL=postgresql://{GCP_DATABASE_USER}:{GCP_DATABASE_PASSWORD}@/{GCP_DATABASE_NAME}?host=/cloudsql/{GCP_INSTANCE}

**Note:** the following also needs to be added to the .env file in contrib/docker-GCP when wanting to run that one locally.
::
        GCP_SQL_INSTANCE

Updating CKAN
------------

When updating CKAN, note that there are `stable versions <https://github.com/ckan/ckan/releases>`_. 
The `master branch <https://github.com/ckan/ckan>`_ can be unstable.

The following adjustments should be kept or adjusted properly when merging to a branch from the forked CKAN repository:

- `Dockerfile <https://github.com/vwt-digital/ckan/blob/develop/Dockerfile>`_:
    | The variable 'GCP' which is checked when copying the entrypoint in order to know which entrypoint to copy (lines 37, 58-63).
    | The activation of the virtual environment in order to install extensions (line 66-72).
- `deployment.ini_tmpl <https://github.com/vwt-digital/ckan/blob/develop/ckan/config/deployment.ini_tmpl>`_:
    | The changing of the port variable to 8080 (unless running locally, as explained before) (line 22).
    | The OAuth2 configuration settings (all variables starting with 'ckan.oauth2.') for the oauth2 extension (lines 78-86).
    | The 'ckan.viewerpermissions.private_orgs' variable for the viewerpermissions extension (lines 88-89).
    | The adding of 'vwt_theme oauth2 viewerpermissions' to the ckan.plugins variable (line 118).
- `environment.py <https://github.com/vwt-digital/ckan/blob/develop/ckan/config/environment.py>`_:
    | The adding of previously mentioned variables to the config_from_env_vars function (lines 157-165).
- `original docker folder <https://github.com/vwt-digital/ckan/tree/develop/contrib/docker>`_:
    | The environment variables for the extensions in the 
      `entrypoint <https://github.com/vwt-digital/ckan/tree/develop/contrib/docker>`_ (lines 38-50).
    | Also add these env vars to the 
      `docker compose <https://github.com/vwt-digital/ckan/blob/develop/contrib/docker/docker-compose.yml>`_ (lines 36-46).
    | And add these env vars to the 
      `env.template <https://github.com/vwt-digital/ckan/blob/develop/contrib/docker/.env.template>`_ (lines 34-45).
- `GCP docker folder <https://github.com/vwt-digital/ckan/tree/develop/contrib/docker-GCP>`_:
    | **Note:** Don't forget to compare this folder to the contrib/docker folder of the branch you want to merge with.
    | The environment variables for the extensions in the 
      `entrypoint <https://github.com/vwt-digital/ckan/blob/develop/contrib/docker-GCP/ckan-entrypoint.sh>`_ (lines 37-49).
    | The startup of the Redis server is also added but this might not be necessary in future versions (lines 56-57).
    | The search-index rebuild is necessary in order for the database to refill after the site being down for too long (line 78).
    | The `docker compose <https://github.com/vwt-digital/ckan/blob/develop/contrib/docker-GCP/docker-compose.yml>`_ 
      has been adjusted completely to have a GCP SQL proxy to the SQL database instead of a local database. Also the env 
      vars for the extensions have been added.
    | The environment variables for the extensions have also been added to the 
      `env.template <https://github.com/vwt-digital/ckan/blob/develop/contrib/docker-GCP/.env.template>`_ (lines 38-49).
      Along with the environment variables to set the GCP SQL database (lines 27-29). And the removal of any environment variables 
      used to setup a database locally.

**Note:** Don't forget to update the above line numbers if they are changed due to a merge.

Support
-------
If you need help with CKAN or want to ask a question, use either the
`ckan-dev`_ mailing list or the `CKAN tag on Stack Overflow`_ (try
searching the Stack Overflow and ckan-dev `archives`_ for an answer to your
question first).

If you've found a bug in CKAN, open a new issue on CKAN's `GitHub Issues`_ (try
searching first to see if there's already an issue for your bug).

If you find a potential security vulnerability please email security@ckan.org,
rather than creating a public issue on GitHub.

.. _CKAN tag on Stack Overflow: http://stackoverflow.com/questions/tagged/ckan
.. _archives: https://www.google.com/search?q=%22%5Bckan-dev%5D%22+site%3Alists.okfn.org.
.. _GitHub Issues: https://github.com/ckan/ckan/issues
.. _CKAN chat on Gitter: https://gitter.im/ckan/chat


Contributing to CKAN
--------------------

For contributing to CKAN or its documentation, see
`CONTRIBUTING <https://github.com/ckan/ckan/blob/master/CONTRIBUTING.rst>`_.

Mailing List
~~~~~~~~~~~~

Subscribe to the `ckan-dev`_ mailing list to receive news about upcoming releases and
future plans as well as questions and discussions about CKAN development, deployment, etc.

Community Chat
~~~~~~~~~~~~~~

If you want to talk about CKAN development say hi to the CKAN developers and members of
the CKAN community on the public `CKAN chat on Gitter`_. Gitter is free and open-source;
you can sign in with your GitHub, GitLab, or Twitter account.

The logs for the old `#ckan`_ IRC channel (2014 to 2018) can be found here:
https://github.com/ckan/irc-logs.

Wiki
~~~~

If you've figured out how to do something with CKAN and want to document it for
others, make a new page on the `CKAN wiki`_ and tell us about it on the
ckan-dev mailing list or on Gitter.

.. _ckan-dev: http://lists.okfn.org/mailman/listinfo/ckan-dev
.. _#ckan: http://webchat.freenode.net/?channels=ckan
.. _CKAN Wiki: https://github.com/ckan/ckan/wiki
.. _CKAN chat on Gitter: https://gitter.im/ckan/chat


Copying and License
-------------------

This material is copyright (c) 2006-2018 Open Knowledge Foundation and contributors.

It is open and licensed under the GNU Affero General Public License (AGPL) v3.0
whose full text may be found at:

http://www.fsf.org/licensing/licenses/agpl-3.0.html
